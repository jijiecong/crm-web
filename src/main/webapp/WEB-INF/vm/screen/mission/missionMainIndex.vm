##sumoselect
<link href="$formLink/admin/media/css/sumoselect.css" rel="stylesheet">
<script src="$formLink/admin/media/js/jquery.sumoselect.min.js"></script>

<link href="$formLink/admin/media/css/bosco/list.css"
      rel="stylesheet" type="text/css">
<link href="$formLink/admin/media/css/jquery.mCustomScrollbar.css"
      rel="stylesheet" type="text/css">
<link href="$formLink/admin/media/css/bootstrap-select.min.css" rel="stylesheet" type="text/css">

<script src="${formLink}/admin/media/js/bootstrap-select.js"></script>
<link href="$formLink/admin/media/js/need/laydate.css" rel="stylesheet" media="screen" type="text/css">
<link href="$formLink/admin/media/js/skins/default/laydate.css" rel="stylesheet" media="screen" type="text/css">
<script src="${formLink}/admin/media/js/laydate.js"></script>
<link href="$formLink/admin/media/css/emojione.min.css" rel="stylesheet">
<script src="$formLink/admin/media/js/emojione.min.js"></script>

<style type="text/css">
    .u-tips {
        display: none;
        position: fixed;
        height: auto;
        z-index: 99999;
        left: 50%;
        top: 50%;
        width: 236px;
        margin-left: -118px;
        padding: 8px;
        line-height: 24px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, .6);
        text-align: center;
        font-size: 20px;
        color: #fff;
        font-size: 1.4rem;
    }


</style>

<div class="page-content">

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span12">
                <h3 class="page-title">任务列表</h3>
                <span>$!message</span>
            </div>
        </div>
        <div class="row-fluid margin-bottom-20 content-area">
            <div class="span12 list-action-top-area">
                <form id="mission_index_form" class="form-horizontal listSearchBox" action="/mission/missionMainIndex" method="post">
                    <div class="span12">
                        <span class="help-inline">任务ID：</span>
                        <input type="text" class="m-wrap small" name="missionIdSearch" id="missionIdSearch" value="$!missionIdSearch">
                        <span class="help-inline">任务名称：</span>
                        <input type="text" class="m-wrap small" name="missionNameSearch" id="missionNameSearch" value="$!missionNameSearch">
                        <span class="help-inline">开始时间：</span>
                        <input type="text" class="m-wrap small laydate-icon" name="missionStartTimeSearch" id="missionStartTimeSearch"  value="$!missionStartTimeSearch">
                        <span class="help-inline">结束时间：</span>
                        <input type="text" class="m-wrap small laydate-icon" name="missionEndTimeSearch" id="missionEndTimeSearch" value="$!missionEndTimeSearch">
                        <span class="help-inline">创建时间：</span>
                        <input type="text" class="m-wrap small laydate-icon" name="missionCreateStartTimeSearch" id="missionCreateStartTimeSearch"  value="$!missionCreateStartTimeSearch">
                        <span class="help-inline">至</span>
                        <input type="text" class="m-wrap small laydate-icon" name="missionCreateEndTimeSearch" id="missionCreateEndTimeSearch"  value="$!missionCreateEndTimeSearch">
                        <br>
                        <span >排序方式</span>
                        <select name="sortSearch" class="select_input" id="sort_input">
                            <option value=1
                                #if($!sortSearch==1)
                                    selected="selected"
                                #end
                            >添加时间倒序
                            </option>
                            <option value=2
                                #if($!sortSearch==2)
                                    selected="selected"
                                #end
                            >添加时间顺序
                            </option>
                            <option value=3
                                #if($!sortSearch==3)
                                    selected="selected"
                                #end
                            >开始时间倒序
                            </option>
                            <option value=4
                                #if($!sortSearch==4)
                                    selected="selected"
                                #end
                            >开始时间顺序
                            </option>
                        </select>
                    ##                    隐藏的输入框，存储表格里的选择
                        <input id="state_input_hidden" name="stateSearch" value="$!stateSearch" type="hidden" class="hiddenInput" selectId="state_select"></input>
                        <input id="type_input_hidden" name="typeSearch" value="$!typeSearch" type="hidden" class="hiddenInput" selectId="type_select"></input>
                        <input id="channel_input_hidden" name="channelSearch" value="$!channelSearch" type="hidden" class="hiddenInput" selectId="channel_select"></input>
                        <input id="create_user_input_hidden" name="createUserSearch" value="$!createUserSearch" type="hidden" ></input>
                        <button id="mission_index_submit_button" type="submit" class="btn blue search-btn">查 询</button>
                        <a id="" type="" class="btn green add-btn" style="margin-left: 10px">新 增</a>
                    </div>
                </form>

                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="icon-cogs"></i>
                            任务列表
                        </div>
                    </div>

                    <div class="portlet-body">
                        <table class="table table-condensed table-hover">
                            <colgroup>
                            ##                        任务ID
                                <col style="width: 5%">
                            ##                          任务名称
                                <col style="width: 18%">
                            ##                          任务状态
                                <col style="width: 9%">
                            ##                          任务类型
                                <col style="width: 9%">
                            ##                          开始时间
                                <col style="width: 12%">
                            ##                          结束时间
                                <col style="width: 12%">
                            ##                          投放渠道
                                <col style="width: 15%">
                            ##                          创建时间
                                <col style="width: 12%">
                            ##                          创建人
                                <col style="width: 10%">


                            ##                          操作
                                <col style="width: 10%">
                            </colgroup>
                            <thead>
                            <tr>
                            ##                        <th><input type="checkbox" id="all-checkbox"></th>
                                <th>任务ID</th>
                                <th>任务名称</th>
                            ##    任务状态
                                <th>
                                ##                            TODO select的宽度不应该是px 再调整
                                    <select id="state_select" class="SumoSelect" inputId="state_input_hidden"  multiple="multiple" style="border: none;width: 90px;height: 10px">
                                        <option value="1">待上架</option>
                                        <option value="3">已上架</option>
                                        <option value="6">已下架</option>
                                    </select>

                                </th>
                            ##    任务类型
                                <th>
                                    <select id="type_select" class="SumoSelect" inputId="type_input_hidden"  multiple="multiple" style="border: none;width: 90px;height: 10px">
                                        #foreach($type in $!totalTypes)
                                            <option  value="$!type.typeName">$!type.typeNameDesc</option>
                                        #end
                                    </select>
                                </th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                            ##    投放渠道
                                <th>
                                    <select id="channel_select" class="SumoSelect" inputId="channel_input_hidden"  multiple="multiple" style="border: none;width: 90px;height: 10px">
                                        #foreach($channel in $!totalChannels)
                                            <option  value="$!channel.id">$!channel.channelName</option>
                                        #end
                                    </select>
                                </th>
                                <th>创建时间</th>
                            ##   创建人
                                <th>
                                    <select id="create_user_select" class="SumoSelect" inputId="create_user_input_hidden"  multiple="multiple" style="border: none;width: 130px;height: 10px">
                                    </select>
                                </th>


                                <th style="text-align: center"><span style="text-align: center">操作</span></th>
                            </tr>
                            </thead>

                            <tbody>
                        #foreach($basicVO in $basicVOList)
                        <tr class="u_$!basicVO.id" data-uid="$!basicVO.id">
##                            <td><input type="checkbox" name="mission_id" class="list-checkbox" value="$!basicVO.id"></td>
                            <td >$!basicVO.id</td>
                            <td class="emoji"><a href="/mission/missionGlobalDetail?id=$basicVO.id" >$!basicVO.missionName</a></td>
                            <td >
                                #if($!basicVO.state==1)
                                待上架
                                #elseif($!basicVO.state==3)
                                已上架
                                #elseif($!basicVO.state==6)
                                已下架
                                #else
                                未知状态
                                #end
                            </td>
##                            转换成中文
                            <td >$!basicVO.missionType</td>
                            <td >$dateUtils.format($!basicVO.beginTime,"yyyy-MM-dd HH:mm:ss")</td>
                            <td >$dateUtils.format($!basicVO.endTime,"yyyy-MM-dd HH:mm:ss")</td>
##                            TODO appName两边都有逗号
                            <td data-uid="$!basicVO.id" >
                            #*    #foreach($channelVO in $!basicVO.channelVOList)
                                $!channelVO.channelName
                                #end*#
                                    $!basicVO.channelIdsDesc
                            </td>
                            <td >$dateUtils.format($!basicVO.gmtCreated,"yyyy-MM-dd HH:mm:ss")</td>
                            <td >$!basicVO.createUserName</td>

                           #* <td >$dateUtils.format($!basicVO.gmtModified,"yyyy-MM-dd HH:mm:ss")</td>*#


                            <td data-uid="$!basicVO.id" >
                                <div class="btn-group">
##                                    #set($cpage = $pageUtil.pager($curPage, $pageSize, $totalCount))
##                                    #set($url = $formLink.setTarget('/mission/missionMainIndex').addQueryData('missionIdSearch',  "$!missionIdSearch").addQueryData('missionNameSearch',  "$!missionNameSearch").addQueryData('missionStartTimeSearch',"$!missionStartTimeSearch").addQueryData('missionEndTimeSearch',"$!missionEndTimeSearch").addQueryData('missionCreateStartTimeSearch',"$!missionCreateStartTimeSearch").addQueryData('missionCreateEndTimeSearch',"$!missionCreateEndTimeSearch").addQueryData('stateSearch',"$!stateSearch").addQueryData("typeSearch",$!typeSearch).addQueryData("channelSearch",$!channelSearch).addQueryData("createUserSearch",$!createUserSearch).addQueryData('sortSearch',"$!sortSearch").fork())
                                    <a class="btn mini purple setForm" onclick="missionQRCode(this);" data-toggle="modal"  data-uid="$!basicVO.id" >
                                       预览 #*<i class="icon-angle-down"></i>*#
                                    </a>
                                </div>
                            #if($basicVO.state!=1)
                            <div class="btn-group">
                                    <a href="#mission_online__div" data-toggle="modal"
                                       class="btn mini red review"  style="margin-left: 3px;" data-uid="$!basicVO.id">
                                        <i class="icon-cog"></i> 任务结果审核
                                    </a>
                            </div>
                            #end

                                    #if($basicVO.state!=3&&$basicVO.state!=4)
                                    <div class="btn-group">
                                        <a href="#mission_online__div" data-toggle="modal"
                                           class="btn mini green edit"  style="margin-left: 3px;" data-uid="$!basicVO.id">
                                            <i class="icon-cog"></i> 编辑
                                        </a>
                                    </div>
                                    #end


                            </td>
                        </tr>
                        #end
                    </tbody>
                </table>
            </div>
        </div>
        #if ($totalCount > 0)
            <div class="pages" style="padding:3px">
                #set($cpage = $pageUtil.pager($curPage, $pageSize, $totalCount))
				        #set($url = $formLink.setTarget('/mission/missionMainIndex').addQueryData('missionIdSearch',  "$!missionIdSearch").addQueryData('missionNameSearch',  "$!missionNameSearch").addQueryData('missionStartTimeSearch',"$!missionStartTimeSearch").addQueryData('missionEndTimeSearch',"$!missionEndTimeSearch").addQueryData('missionCreateStartTimeSearch',"$!missionCreateStartTimeSearch").addQueryData('missionCreateEndTimeSearch',"$!missionCreateEndTimeSearch").addQueryData('stateSearch',"$!stateSearch").addQueryData("typeSearch",$!typeSearch).addQueryData("channelSearch",$!channelSearch).addQueryData("createUserSearch",$!createUserSearch).addQueryData('sortSearch',"$!sortSearch").fork())
				   		#showPage($cpage $url)
            </div>
        #end
    </div>
</div>

<div id="mission_state_choose_div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<h3>任务状态</h3>
    <form action="/mission/missionMainIndex" class="form-horizontal listSearchBox" method="post">
        <div>
            <input id="state1" value="1" type="checkbox" name="stateSearch"  >待上架</input>
        </div>
        <div>
            <input id="state3" value="3" type="checkbox" name="stateSearch" >已上架</input>
        </div>
        <div>
            <input id="state6" value="6" type="checkbox" name="stateSearch" >已下架</input>
        </div>

        <input id ="state_hidden" value="$!stateSearch" type="hidden"></input>
        <div>
            <button id="state_choose_submit_butoon" class="btn yellow submit">确 认</button>
        </div>
    </form>
</div>

<div id="mission_type_choose_div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
    <h3>任务类型</h3>
    <form action="/mission/missionMainIndex" class="form-horizontal listSearchBox" method="post">

        #foreach($type in $!totalTypes)
            <div>
                <input value=$!type.id type="checkbox" name="typeSearch"  >$!type.typeName</input>
            </div>
        #end
        <input id ="type_hidden" value="$!typeSearch" type="hidden"></input>
        <div>
            <button id="type_choose_submit_butoon" class="btn yellow submit">确 认</button>
        </div>
    </form>
</div>

<div id="channel_choose_div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
    <h3>投放渠道</h3>
    <form action="/mission/missionMainIndex" class="form-horizontal listSearchBox" method="post">

        #foreach($channel in $!totalChannels)
            <div>
                <input value=$!channel.id type="checkbox" name="channelSearch"  >$!channel.channelName</input>
            </div>
        #end
        <input id ="channel_hidden" value="$!channelSearch" type="hidden"></input>
        <div>
            <button id="channel_choose_submit_butoon" class="btn yellow submit">确 认</button>
        </div>
    </form>
</div>

<div id="create_user_choose_div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
    <h3>创建人</h3>
    <form action="/mission/missionMainIndex" class="form-horizontal listSearchBox" method="post">

        #foreach($user in $!totalUsers)
            <div>
                <input value=$!user.id type="checkbox" name="createUserSearch"  >$!user.userName</input>
            </div>
        #end
        <input id ="create_user_hidden" value="$!createUserSearch" type="hidden"></input>
        <div>
            <button id="create_user_choose_submit_butoon" class="btn yellow submit">确 认</button>
        </div>
    </form>
</div>

#*<div id="mission_online__div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
    <h3>确认上架任务?</h3>
    <form  class="form-horizontal listSearchBox" method="post">

        <div>
            <button id="mission_online_submit" class="btn yellow submit" value="">确 认</button>
        </div>
    </form>
</div>

<div id="mission_offline__div" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
    <h3>确认下架任务?</h3>
    <form  class="form-horizontal listSearchBox" method="post">

        <div>
            <button id="mission_offline_submit" class="btn yellow submit">确 认</button>
        </div>
    </form>
</div>*#


<input type="hidden" id="selectedBasicRegion"/>

<script>
    seajs.use("$formLink/admin/static/app/mission/missionIndex", function (main) {
//        main.init();
    });

    /**初始化创建人*/
    $(document).ready(function () {
        var checkedUsers=$("#create_user_input_hidden").val();
        $.ajax({
            type : "get",
            dataType :"json",
            data : {

            },
            url :  "/mission/allCreateUsers",
            success : function(result){
                if (result.success) {
                    //关闭对话框并且刷新当前页面
                    var users=result.data;
                    var createUserSelect=$("#create_user_select");
                    for(i=0;i<users.length;i++){
                        var checked=checkedUsers.indexOf(users[i].id)!=-1;
                        if (checked){
                            $('<option></option>',{value:users[i].id,selected:'selected',text:users[i].userName}).appendTo(createUserSelect);
                        }else {
                            $('<option></option>',{value:users[i].id,text:users[i].userName}).appendTo(createUserSelect);
                        }
                    }
                    /*sumoselect初始化select一定要在select加载完成以后进行才有效果*/
                    $('#create_user_select').SumoSelect({
                        placeholder:'创建人',
                        csvDispCount:1,
                        captionFormat:'',
                        captionFormatAllSelected:'',
                    });
                }else{
                    alertGlobalErrorCall(result);
                }
            }
        });
    });

    /**
     * ATTENTION 要先给上次选择的option加上selected属性 然后再让sumoselect插件解析option 这样才能实现preselect效果 坑爹啊
     */
    $(document).ready(function (){
        var inputs=$(".hiddenInput");//所有的隐藏输入框
        inputs.each(function (index,input) {
            var selectId=$(this).attr("selectId");//this==input
            var value=input.value;
            //遍历当前select的option，如果option的value在上次选择的value中，则勾选当前option
            $("#"+selectId+" option").each(function (optionIndex,option){
                if(value.indexOf($(option).val())!=-1){
                    $(this).prop('selected','selected');
                }
            });
        });
    })

    /**初始化sumoselect插件*/
    $(document).ready(function () {
        $('#state_select').SumoSelect({
            placeholder:'任务状态',
            csvDispCount:1,
            captionFormat:'',
            captionFormatAllSelected:'',
        });
        $('#type_select').SumoSelect({
            placeholder:'任务类型',
            csvDispCount:1,
            captionFormat:'',
            captionFormatAllSelected:'',
        });
        $('#channel_select').SumoSelect({
            placeholder:'投放渠道',
            csvDispCount:1,
            captionFormat:'',
            captionFormatAllSelected:'',
        });

    });



    /**保存下拉列表选组的值*/
    $(function () {
        $("select.SumoSelect").on("change",function () {
            var inputId=$(this).attr("inputId");
            var values=$(this).val();
            $("#"+inputId).val(values);
        });
    })


    /*验证ID是否为数字*/
    $("#mission_index_submit_button").on("click",function () {
        var id=$("#missionIdSearch").val();
        if (id!=null&&id!=''&&!/^\d+$/.test(id)){
            $.notify("输入的ID必须是数字","warn");
            //取消表单的提交
            return false;
        }
    });

    $(document).ready(function () {//解析emoji表情shortname-->image
        $(".emoji").each(function () {
            var shortName=$(this).html();

            var emoji=emojione.shortnameToImage(shortName);
            $(this).html(emoji);
        })
    })
    function closeIframe() {
        $("#YuFrame1").remove();
        $("#YuFrame1Bg").remove();
    }



    var id;
    $("td").on("click",function () {

        id=$(this).attr("data-uid");

    });




    function closeIframe() {
        $("#YuFrame1").remove();
        $("#YuFrame1Bg").remove();
    }


    var id;
    $("td").on("click",function () {
        id=$(this).attr("data-uid");
    });


    $("#mission_offline_submit").on("click",function () {


        $.ajax({
            type : "POST",
            dataType :"json",
            data : {
                id:id,
                state:6
            },
            url :  "/mission/modify",
            success : function(result){
                if (result.success) {
                    //关闭对话框并且刷新当前页面
                    location.reload();
                }else{
                    alert(result.error);
                }

            }
        });

    });
//    $("#state_choose_submit_butoon").submit

    function loadFormStructure() {
        var formId = $("#selectedBasicRegion").val();
        var formObj;
        if(formId!=-1){
            $.ajax({
                type : "POST",
                dataType :"json",
                async: false,
                data : {
                    id: formId
                },
                url :  "/mission/detail",
                success : function(result){
                    if (result.success) {
                        formObj= result.data;
                    }else{
                        alert(result.error);
                    }

                }
            });
        }
        return formObj;
    }




    $(".add-btn").on("click", function () {

        window.location.href = 'missionTypeSelect' ;

    })

    $(".edit").on("click", function () {

        window.location.href = 'step1?id='+$(this).data('uid');

    })


    $(".review").on("click", function () {

        window.location.href = '/missionTrace/missionReview?id='+$(this).data('uid');

    })
</script>


<script type="text/html" id="drag_choice">
    <li class="ui-module items-questions">
        <div class="theme-type">
            <div class="cq-items-content">
    <li>
        <label class="input-check">
            {{desc}} <input type="text" name="{{name}}" value="{{value}}">
        </label>
    </li>
    </div>
    </div>
    </li>
</script>


<script type="text/javascript">
    var start = {
        elem: '#missionStartTimeSearch',
        format: 'YYYY-MM-DD hh:mm:ss',
        max: '2099-06-16 23:59:59', //最大日期
        istime: true,
        istoday: true,
        choose: function(datas){
            end.min = datas; //开始日选好后，重置结束日的最小日期
            end.start = datas //将结束日的初始值设定为开始日
        }
    };
    var end = {
        elem: '#missionEndTimeSearch',
        format: 'YYYY-MM-DD hh:mm:ss',
        max: '2099-06-16 23:59:59',
        istime: true,
        istoday: false,
        choose: function(datas){
            start.max = datas; //结束日选好后，重置开始日的最大日期
        }
    };
    laydate(start);
    laydate(end);
    var start2 = {
        elem: '#missionCreateStartTimeSearch',
        format: 'YYYY-MM-DD hh:mm:ss',
        max: '2099-06-16 23:59:59', //最大日期
        istime: true,
        istoday: true,
        choose: function(datas){
            end2.min = datas; //开始日选好后，重置结束日的最小日期
            end2.start = datas //将结束日的初始值设定为开始日
        }
    };
    var end2 = {
        elem: '#missionCreateEndTimeSearch',
        format: 'YYYY-MM-DD hh:mm:ss',
        max: '2099-06-16 23:59:59',
        istime: true,
        istoday: false,
        choose: function(datas){
            start2.max = datas; //结束日选好后，重置开始日的最大日期
        }
    };
    laydate(start2);
    laydate(end2);
</script>
